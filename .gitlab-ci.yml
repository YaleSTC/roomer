include:
  - template: Code-Quality.gitlab-ci.yml

.test_template: &test_definition
  image: ruby:2.6.5-stretch

  tags:
    - yale

  services:
    - postgres:latest

  variables:
    POSTGRES_DB: gitlab_ci_test
    POSTGRES_USER: runner
    POSTGRES_PASSWORD: ""

  stage: test

  before_script:
    - apt-get update -q
    - curl -sL https://deb.nodesource.com/setup_10.x | bash - && apt-get install -y nodejs
    - ruby -v
    - which ruby

  cache:
    paths:
      - vendor/bundle

spec:
  <<: *test_definition
  script:
    - bundle check --path vendor/bundle || bundle install --path vendor/bundle
    - cp config/database.yml.gitlab config/database.yml
    - bundle exec rake
  after_script:
    - bundle exec codeclimate-test-reporter

style:
  <<: *test_definition
  script:
    - bundle check --path vendor/bundle || bundle install --path vendor/bundle
    - cp config/database.yml.gitlab config/database.yml
    - bundle exec rake check_style 'git diff origin/master --name-status'
